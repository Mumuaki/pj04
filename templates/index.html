{% extends 'base.html' %}
{% load static %}
{% load service_tags %}

{% block content %}

{% if not user.is_authenticated %}
<div class="search-container">
    <h2>Проверьте комплектацию и технические характеристики техники Силант</h2>
    <form method="get">
        <input type="text" name="serial_number" placeholder="Заводской номер"
            value="{{ request.GET.serial_number|default:'' }}" required>
        <button type="submit" class="auth-btn">Поиск</button>
    </form>
</div>

{% if search_performed %}
{% if search_result %}
<h3>Результат поиска:</h3>
<div class="table-responsive">
    <table>
        <thead>
            <tr>
                <th>Зав. № машины</th>
                <th>Модель техники</th>
                <th>Модель двигателя</th>
                <th>Зав. № двигателя</th>
                <th>Модель трансмиссии</th>
                <th>Зав. № трансмиссии</th>
                <th>Модель ведущего моста</th>
                <th>Зав. № ведущего моста</th>
                <th>Модель управляемого моста</th>
                <th>Зав. № управляемого моста</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ search_result.serial_number|default:"Не указано" }}</td>
                <td>{{ search_result.technique_model|default:"Не указано" }}</td>
                <td>{{ search_result.engine_model|default:"Не указано" }}</td>
                <td>{{ search_result.engine_serial|default:"Не указано" }}</td>
                <td>{{ search_result.transmission_model|default:"Не указано" }}</td>
                <td>{{ search_result.transmission_serial|default:"Не указано" }}</td>
                <td>{{ search_result.drive_axle_model|default:"Не указано" }}</td>
                <td>{{ search_result.drive_axle_serial|default:"Не указано" }}</td>
                <td>{{ search_result.steering_axle_model|default:"Не указано" }}</td>
                <td>{{ search_result.steering_axle_serial|default:"Не указано" }}</td>
            </tr>
        </tbody>
    </table>
</div>
{% else %}
<p style="color: var(--color-red); text-align: center;">{{ not_found_message|default:"Не найдено" }}</p>
{% endif %}
{% endif %}

{% else %}
<div class="user-info-block">
    <h3>{{ user.name|default:user.username }}</h3>
    <p class="info-text" id="tab-info-text">Информация о комплектации и технических характеристиках Вашей техники</p>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event, 'General')">Общая инфо</button>
    <button class="tab-btn" onclick="openTab(event, 'Maintenance')">ТО</button>
    <button class="tab-btn" onclick="openTab(event, 'Complaints')">Рекламации</button>
</div>

<div class="filters-container">
    <form method="get" class="filter-form">
        <input type="hidden" name="tab" id="active-tab-input" value="general">

        {% if user.is_manager or user.is_service or user.is_superuser or user.is_client %}
        <div id="filter-General" class="filter-group">
            <h4>Фильтр (Машины):</h4>
            <select name="technique_model">
                <option value="">Модель техники</option>
                {% for item in technique_models %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.technique_model %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
            <select name="engine_model">
                <option value="">Модель двигателя</option>
                {% for item in engine_models %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.engine_model %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
            <select name="transmission_model">
                <option value="">Модель трансмиссии</option>
                {% for item in transmission_models %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.transmission_model %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
            <select name="drive_axle_model">
                <option value="">Ведущий мост</option>
                {% for item in drive_axle_models %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.drive_axle_model %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
            <select name="steering_axle_model">
                <option value="">Управляемый мост</option>
                {% for item in steering_axle_models %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.steering_axle_model %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div id="filter-Maintenance" class="filter-group" style="display:none;">
            <h4>Фильтр (ТО):</h4>
            <select name="service_type">
                <option value="">Вид ТО</option>
                {% for item in service_types %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.service_type %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>

            <select name="car_serial_to">
                <option value="">Зав. № машины</option>
                {% for machine in machines_filter_list %}
                <option value="{{ machine.serial_number }}" {% check_selected machine.serial_number request.GET.car_serial_to %}>{{ machine.serial_number|default:"Не указано" }}</option>
                {% endfor %}
            </select>

            <select name="service_company_to">
                <option value="">Сервисная компания</option>
                {% for item in maintenance_filter_service_companies %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.service_company_to %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="filter-Complaints" class="filter-group" style="display:none;">
            <h4>Фильтр (Рекламации):</h4>
            <select name="failure_node">
                <option value="">Узел отказа</option>
                {% for item in failure_nodes %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.failure_node %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
            <select name="recovery_method">
                <option value="">Способ восстановления</option>
                {% for item in recovery_methods %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.recovery_method %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
            <select name="service_company_complaint">
                <option value="">Сервисная компания</option>
                {% for item in complaint_filter_service_companies %}
                <option value="{{ item.id }}" {% check_selected item.id request.GET.service_company_complaint %}>{{ item.name|default:"Не указано" }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="auth-btn filter-btn">Фильтровать</button>
        <a href="{% url 'index' %}" class="reset-btn" id="reset-filter-btn">Сброс</a>
    </form>
</div>

<div id="General" class="tab-content" style="display: block;">
    {% if user.is_manager or user.is_superuser %}
    <div style="margin-bottom: 20px; text-align: right; max-width: 1400px; margin-left: auto; margin-right: auto;">
        <a href="{% url 'machine_create' %}" class="auth-btn" style="text-decoration: none; display: inline-block;">+ Добавить машину</a>
    </div>
    {% endif %}

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Модель техники</th>
                    <th>Зав. № машины</th>
                    <th>Модель двигателя</th>
                    <th>Зав. № двигателя</th>
                    <th>Модель трансмиссии</th>
                    <th>Зав. № трансмиссии</th>
                    <th>Модель ведущего моста</th>
                    <th>Зав. № ведущего моста</th>
                    <th>Модель управляемого моста</th>
                    <th>Зав. № управляемого моста</th>
                    <th>Дата отгрузки</th>
                    {% if not user.is_client %}
                    <th>Клиент</th>
                    {% endif %}
                    <th>Сервисная компания</th>
                </tr>
            </thead>
            <tbody>
                {% for machine in machines %}
                <tr data-href="{% url 'machine_detail' machine.pk %}" class="clickable-row" style="cursor: pointer;">
                    <td>{{ machine.technique_model.name|default:"Не указано" }}</td>
                    <td>{{ machine.serial_number|default:"Не указано" }}</td>
                    <td>{{ machine.engine_model.name|default:"Не указано" }}</td>
                    <td>{{ machine.engine_serial|default:"Не указано" }}</td>
                    <td>{{ machine.transmission_model.name|default:"Не указано" }}</td>
                    <td>{{ machine.transmission_serial|default:"Не указано" }}</td>
                    <td>{{ machine.drive_axle_model.name|default:"Не указано" }}</td>
                    <td>{{ machine.drive_axle_serial|default:"Не указано" }}</td>
                    <td>{{ machine.steering_axle_model.name|default:"Не указано" }}</td>
                    <td>{{ machine.steering_axle_serial|default:"Не указано" }}</td>
                    <td>{{ machine.date_shipment|date:"d.m.Y"|default:"Не указано" }}</td>
                    {% if not user.is_client %}
                    <td>{{ machine.client.name|default:"Не указано" }}</td>
                    {% endif %}
                    <td>{{ machine.service_company.name|default:"Не указано" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if user.is_client %}12{% else %}13{% endif %}">Нет данных</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
            <a href="?{% param_replace page=1 %}">&laquo; первая</a>
            <a href="?{% param_replace page=page_obj.previous_page_number %}">предыдущая</a>
            {% endif %}

            <span class="current">
                Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
            <a href="?{% param_replace page=page_obj.next_page_number %}">следующая</a>
            <a href="?{% param_replace page=page_obj.paginator.num_pages %}">последняя &raquo;</a>
            {% endif %}
        </span>
    </div>
    {% endif %}
</div>

<div id="Maintenance" class="tab-content" style="display: none;">
    <div style="margin-bottom: 20px; text-align: right; max-width: 1400px; margin-left: auto; margin-right: auto;">
        <a href="{% url 'maintenance_create' %}" class="auth-btn" style="text-decoration: none; display: inline-block;">+ Добавить ТО</a>
    </div>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Машина (Зав.№)</th>
                    <th>Вид ТО</th>
                    <th>Дата проведения</th>
                    <th>Наработка, м/час</th>
                    <th>№ заказ-наряда</th>
                    <th>Дата заказ-наряда</th>
                    <th>Организация, проводившая ТО</th>
                </tr>
            </thead>
            <tbody>
                {% for item in maintenances %}
                <tr data-href="{% url 'maintenance_detail' item.pk %}" class="clickable-row" style="cursor: pointer;">
                    <td>{{ item.machine.serial_number|default:"Не указано" }}</td>
                    <td>{{ item.service_type.name|default:"Не указано" }}</td>
                    <td>{{ item.event_date|date:"d.m.Y"|default:"Не указано" }}</td>
                    <td>{{ item.operating_hours|default:"Не указано" }}</td>
                    <td>{{ item.order_number|default:"Не указано" }}</td>
                    <td>{{ item.order_date|date:"d.m.Y"|default:"Не указано" }}</td>
                    <td>{{ item.service_company.name|default:"Не указано" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">Нет записей о ТО</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if maintenances.has_other_pages %}
    <div class="pagination">
        <span class="step-links">
            {% if maintenances.has_previous %}
            <a href="?{% param_replace page_m=1 %}">&laquo; первая</a>
            <a href="?{% param_replace page_m=maintenances.previous_page_number %}">предыдущая</a>
            {% endif %}

            <span class="current">
                Страница {{ maintenances.number }} из {{ maintenances.paginator.num_pages }}.
            </span>

            {% if maintenances.has_next %}
            <a href="?{% param_replace page_m=maintenances.next_page_number %}">следующая</a>
            <a href="?{% param_replace page_m=maintenances.paginator.num_pages %}">последняя &raquo;</a>
            {% endif %}
        </span>
    </div>
    {% endif %}
</div>

<div id="Complaints" class="tab-content" style="display: none;">
    <div style="margin-bottom: 20px; text-align: right; max-width: 1400px; margin-left: auto; margin-right: auto;">
        <a href="{% url 'complaint_create' %}" class="auth-btn" style="text-decoration: none; display: inline-block;">+ Добавить рекламацию</a>
    </div>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Машина (Зав.№)</th>
                    <th>Дата отказа</th>
                    <th>Наработка, м/час</th>
                    <th>Узел отказа</th>
                    <th>Описание отказа</th>
                    <th>Способ восстановления</th>
                    <th>Используемые запчасти</th>
                    <th>Дата восстановления</th>
                    <th>Время простоя (дни)</th>
                    <th>Сервисная компания</th>
                </tr>
            </thead>
            <tbody>
                {% for item in complaints %}
                <tr data-href="{% url 'complaint_detail' item.pk %}" class="clickable-row" style="cursor: pointer;">
                    <td>{{ item.machine.serial_number|default:"Не указано" }}</td>
                    <td>{{ item.failure_date|date:"d.m.Y"|default:"Не указано" }}</td>
                    <td>{{ item.operating_hours|default:"Не указано" }}</td>
                    <td>{{ item.failure_node.name|default:"Не указано" }}</td>
                    <td>{{ item.failure_description|truncatechars:50|default:"Не указано" }}</td>
                    <td>{{ item.recovery_method.name|default:"Не указано" }}</td>
                    <td>{{ item.spare_parts|truncatechars:30|default:"Не указано" }}</td>
                    <td>{{ item.recovery_date|date:"d.m.Y"|default:"Не указано" }}</td>
                    <td>{{ item.downtime|default:"Не указано" }}</td>
                    <td>{{ item.service_company.name|default:"Не указано" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10">Нет записей о рекламациях</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if complaints.has_other_pages %}
    <div class="pagination">
        <span class="step-links">
            {% if complaints.has_previous %}
            <a href="?{% param_replace page_c=1 %}">&laquo; первая</a>
            <a href="?{% param_replace page_c=complaints.previous_page_number %}">предыдущая</a>
            {% endif %}

            <span class="current">
                Страница {{ complaints.number }} из {{ complaints.paginator.num_pages }}.
            </span>

            {% if complaints.has_next %}
            <a href="?{% param_replace page_c=complaints.next_page_number %}">следующая</a>
            <a href="?{% param_replace page_c=complaints.paginator.num_pages %}">последняя &raquo;</a>
            {% endif %}
        </span>
    </div>
    {% endif %}
</div>

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";

        if (evt) {
            evt.currentTarget.className += " active";
        } else {
            let btnIndex = 0;
            if (tabName === 'Maintenance') btnIndex = 1;
            if (tabName === 'Complaints') btnIndex = 2;
            if (tablinks[btnIndex]) tablinks[btnIndex].classList.add("active");
        }

        let filterGroups = document.getElementsByClassName("filter-group");
        for (i = 0; i < filterGroups.length; i++) {
            filterGroups[i].style.display = "none";
        }
        let activeFilter = document.getElementById("filter-" + tabName);
        if (activeFilter) {
            activeFilter.style.display = "block";
        }

        let infoText = document.getElementById("tab-info-text");
        if (infoText) {
            if (tabName === 'General') {
                infoText.textContent = "Информация о комплектации и технических характеристиках Вашей техники";
            } else if (tabName === 'Maintenance') {
                infoText.textContent = "Информация о проведенных ТО вашей техники";
            } else if (tabName === 'Complaints') {
                infoText.textContent = "Информация о рекламациях вашей техники";
            }
        }

        let tabInput = document.getElementById("active-tab-input");
        if (tabInput) {
            tabInput.value = tabName.toLowerCase();
        }

        let resetBtn = document.getElementById("reset-filter-btn");
        if (resetBtn) {
            resetBtn.href = window.location.pathname + (tabName === 'General' ? '' : '?tab=' + tabName.toLowerCase());
        }

        localStorage.setItem('activeTab', tabName);
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        let hasQueryParams = urlParams.toString().length > 0;

        let activeTab = 'General';
        if (tabParam) {
            if (tabParam === 'maintenance') activeTab = 'Maintenance';
            if (tabParam === 'complaints') activeTab = 'Complaints';
            if (tabParam === 'general') activeTab = 'General';
        } else if (hasQueryParams) {
            activeTab = localStorage.getItem('activeTab') || 'General';
        }

        openTab(null, activeTab);

        const rows = document.querySelectorAll(".clickable-row");
        rows.forEach(row => {
            row.addEventListener("click", function () {
                window.location.href = this.dataset.href;
            });
        });
    });
</script>

{% endif %}

{% endblock %}